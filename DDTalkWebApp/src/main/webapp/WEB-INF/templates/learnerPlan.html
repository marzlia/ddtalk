<!DOCTYPE html>
<html>

<head th:replace="learnerFragments :: standard_head"></head>

<body>

<div th:replace="learnerFragments :: learner_header"></div>

<br /><br /><br />

<table class="table-style-standard">
    <tr>
        <td th:text="${#dates.format(plan.dateStartPlan, 'MMM dd, yyyy')}"></td>
        <td th:text="${plan.treatmentFrequency}"></td>
        <td th:text="${plan.dataCollectFrequency}"></td>
    </tr>
</table>

<br /><br /><br />

<div th:each="mapEntry : ${domainObjectivesMap}">
    <label th:text="${mapEntry.key.description}" class="label-style-domain"></label>
    <div th:each="planObjective : ${mapEntry.value}">
        <table class="table-style-standard">
            <tr>
                <td th:text="${planObjective.objective.description}"></td>
                <td>
                <select>
                    <option th:each="objectiveType : ${objectiveTypes}"
                            th:value="${objectiveType.typeId}"
                            th:text="${objectiveType.typeDescription}"
                            th:selected="${planObjective.objectiveType.typeId == objectiveType.typeId}"/>
                </select>
                </td>
            </tr>
            <tr th:if="${planObjective.objectiveType.typeId == 'C'}">
                <table class="table-style-standard">
                    <tr>
                        <td>
                            <select>
                                <option th:each="masteryCount : ${masteryCounts}"
                                        th:value="${masteryCount}"
                                        th:text="${masteryCount}"/>
                            </select>
                        </td>
                        <td>
                            <select>
                                <option th:each="condition : ${conditions}"
                                        th:value="${condition}"
                                        th:text="${condition.description}"/>
                            </select>
                        </td>
                        <td>
                            <select>
                                <option th:each="criteria : ${criterias}"
                                        th:value="${criteria}"
                                        th:text="${criteria.description}"/>
                            </select>
                        </td>
                    </tr>
                </table>
            </tr>
            <tr th:if="${planObjective.objectiveType.typeId == 'P'}">
                <table class="table-style-standard">
                    <tr>
                        <td>
                            <select>
                                <option th:each="masteryPercent : ${masteryPercents}"
                                        th:value="${masteryPercent}"
                                        th:text="${masteryPercent} + '%'"/>
                            </select>
                        </td>
                        <td>
                            <select>
                                <option th:each="condition : ${conditions}"
                                        th:value="${condition}"
                                        th:text="${condition.description}"/>
                            </select>
                        </td>
                        <td>
                            <select>
                                <option th:each="criteria : ${criterias}"
                                        th:value="${criteria}"
                                        th:text="${criteria.description}"/>
                            </select>
                        </td>
                    </tr>
                </table>
            </tr>
         </table>
    </div>
    <br /><br />
</div>

<div>
    <div>
        <label for="select-domain">Add Domain Objective:</label>
        <select id="select-domain" placeholder="Select a domain...">
            <option th:each="domain : ${emptyDomains}"
                    th:value="${domain.domainId}"
                    th:text="${domain.description}"/>
        </select>
    </div>
</div>

<script>
    $('#select-domain').selectize({
        create: false,
        dropdownParent: 'body',
        onChange: function(value) {
            $.ajax({
                url: '../lookup/objectives/' + value,
                type: 'GET',
                dataType: 'json',
                success: function (data) {
                    var selectize = $('#select-objective')[0].selectize;
                    selectize.clearOptions();
                    selectize.renderCache = {};
                    selectize.load( function(callback) {
                        callback(data);
                    });
                }
            });
        }
    });
</script>

<div>
    <select id="select-objective" placeholder="Select an objective..." />
</div>

<script>
    $('#select-objective').selectize({
        create: true,
        valueField: 'objectiveId',
        labelField: 'description',
        searchField: 'description',
        sortField: {
            field: 'description',
            direction: 'asc'
        }
    });
</script>

<form th:action="@{addObjective}" th:object="${addObjectiveRequest}" method="post" id="add_objective_form">
</form>

<div type="hidden" th:value="${plan.learnerPlanId}" id="postPlanId"/>
<button onclick="addObjective()">Add Objective</button>

<script type="text/javascript">
    var addObjective = function() {
        var selectizeObjective = $('#select-objective')[0].selectize;
        var selectizeDomain = $('#select-domain')[0].selectize;

        var planId = $('#postPlanId').attr('value');
        var objectiveId = selectizeObjective.getValue();
        var domainId = selectizeDomain.getValue();

        var theAction = $('#add_objective_form').attr('action');
        var theCSRF = $("[name^='_csrf']").attr('value');
        $.ajax({
            url: theAction,
            type: 'POST',
            headers: {
                '_csrf':theCSRF
            },
            data: {
                learnerPlanId: planId,
                domainId: domainId,
                objectiveId: objectiveId,
                _csrf:theCSRF
            },
            dataType:'json',
            success: function (data) {
                alert(data);
            },
            failure: function (data) {
                alert(data);
            }
        });
    }
</script>

</body>
</html>