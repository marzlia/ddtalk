<!DOCTYPE html>
<html>

<head th:replace="learnerFragments :: standard_head"></head>

<body>

<div th:replace="learnerFragments :: learner_header"></div>

<br /><br /><br />

<table class="table-style-standard">
    <tr>
        <td th:text="${#dates.format(plan.dateStartPlan, 'MMM dd, yyyy')}"></td>
        <td th:text="${plan.treatmentFrequency}"></td>
        <td th:text="${plan.dataCollectFrequency}"></td>
    </tr>
</table>

<br /><br /><br />

<fieldset>
    <legend>Add Objective</legend>
    <div>
        <div>
            <label for="select-domain"></label>
            <select id="select-domain" placeholder="Select a domain...">
                <option th:each="domain : ${emptyDomains}"
                        th:value="${domain.domainId}"
                        th:text="${domain.description}"/>
            </select>
        </div>
    </div>

    <div>
        <select id="select-objective" placeholder="Select an objective..." />
    </div>

    <div>
        <div>
            <select id="select-objective-type">
                <option th:each="objectiveType : ${objectiveTypes}"
                        th:value="${objectiveType.objectiveTypeId}"
                        th:text="${objectiveType.typeDescription}"/>
            </select>
        </div>
    </div>

    <form th:action="@{addObjective}" th:object="${addObjectiveRequest}" method="post" id="add_objective_form">
    </form>

    <div type="hidden" th:value="${plan.learnerPlanId}" id="postPlanId"/>
    <button onclick="addObjective()">Add Objective</button>
</fieldset>

<br /><br />

<div th:each="mapEntry : ${domainObjectivesMap}">
    <label th:text="${mapEntry.key.description}" class="label-style-domain"></label>
    <div th:each="planObjective : ${mapEntry.value}">
        <table class="table-style-standard">
            <tr>
                <td th:text="${planObjective.objective.description}"></td>
            </tr>
            <tr th:if="${planObjective.objectiveType.typeId == 'C'}">
                <table class="table-style-standard" id="C" th:id="${planObjective.learnerPlanObjectiveId}">
                    <tr>
                        <td>
                            <select name="mastery">
                                <option th:each="masteryCount : ${masteryCounts}"
                                        th:value="${masteryCount}"
                                        th:text="${masteryCount}"
                                        th:selected="${masteryCount == planObjective.masteryValue}"/>
                            </select>
                        </td>
                        <td>
                            <select name="condition">
                                <option th:each="condition : ${conditions}"
                                        th:value="${condition.conditionId}"
                                        th:text="${condition.description}"
                                        th:selected="${planObjective.condition} ? ${condition.conditionId == planObjective.condition.conditionId}"/>
                            </select>
                        </td>
                        <td>
                            <select name="criteria">
                                <option th:each="criteria : ${criterias}"
                                        th:value="${criteria.criteriaId}"
                                        th:text="${criteria.description}"
                                        th:selected="${planObjective.criteria} ? ${criteria.criteriaId == planObjective.criteria.criteriaId}"/>
                            </select>
                        </td>
                    </tr>
                </table>
            </tr>
            <tr th:if="${planObjective.objectiveType.typeId == 'P'}">
                <table class="table-style-standard" id="P" th:id="${planObjective.learnerPlanObjectiveId}">
                    <tr>
                        <td>
                            <select name="mastery">
                                <option th:each="masteryPercent : ${masteryPercents}"
                                        th:value="${masteryPercent}"
                                        th:text="${masteryPercent} + '%'"
                                        th:selected="${masteryPercent == planObjective.masteryValue}"/>
                            </select>
                        </td>
                        <td>
                            <select name="condition">
                                <option th:each="condition : ${conditions}"
                                        th:value="${condition.conditionId}"
                                        th:text="${condition.description}"
                                        th:selected="${planObjective.condition} ? ${condition.conditionId == planObjective.condition.conditionId}"/>
                            </select>
                        </td>
                        <td>
                            <select name="criteria">
                                <option th:each="criteria : ${criterias}"
                                        th:value="${criteria.criteriaId}"
                                        th:text="${criteria.description}"
                                        th:selected="${planObjective.criteria} ? ${criteria.criteriaId == planObjective.criteria.criteriaId}"/>
                            </select>
                        </td>
                    </tr>
                </table>
            </tr>
         </table>
    </div>
    <br /><br />
</div>
<button onclick="updateObjectives()">Save Changes</button>

<form th:action="@{updateObjectives}" th:object="${plan}" method="post" id="update_objectives_form">
</form>

<script>
    $('#select-domain').selectize({
        create: false,
        dropdownParent: 'body',
        onChange: function(value) {
            $.ajax({
                url: '../lookup/objectives/' + value,
                type: 'GET',
                dataType: 'json',
                success: function (data) {
                    var selectize = $('#select-objective')[0].selectize;
                    selectize.clearOptions();
                    selectize.renderCache = {};
                    selectize.load( function(callback) {
                        callback(data);
                    });
                }
            });
        }
    });

    $('#select-objective').selectize({
        create: true,
        valueField: 'objectiveId',
        labelField: 'description',
        searchField: 'description',
        sortField: {
            field: 'description',
            direction: 'asc'
        }
    });

    $('#select-objective-type').selectize({
        create: false
    });

    var addObjective = function() {
        var selectizeObjective = $('#select-objective')[0].selectize;
        var selectizeDomain = $('#select-domain')[0].selectize;
        var selectizeObjectiveType = $('#select-objective-type')[0].selectize;

        var planId = $('#postPlanId').attr('value');
        var objectiveId = selectizeObjective.getValue();
        var domainId = selectizeDomain.getValue();
        var objectiveTypeId = selectizeObjectiveType.getValue();

        var theAction = $('#add_objective_form').attr('action');
        var theCSRF = $("[name^='_csrf']").attr('value');
        $.ajax({
            url: theAction,
            type: 'POST',
            headers: {
                '_csrf':theCSRF
            },
            data: {
                learnerPlanId: planId,
                domainId: domainId,
                objectiveId: objectiveId,
                objectiveTypeId: objectiveTypeId,
                _csrf:theCSRF
            },
            dataType:'json',
            success: function (data) {
                location.reload();
            },
            error: function() {
            }
        });
    };

    var updateObjectives = function() {
        var theAction = $('#update_objectives_form').attr('action');
        var theCSRF = $("[name^='_csrf']").attr('value');

        var allObjectiveTables = $('table[id]');
        jQuery.each( allObjectiveTables, function( i, val ) {
            var planObjectiveId = $(val).attr("id");
            var columns = $(val).find('tbody > tr > td');

            var masteryCol = $(columns).find('[name="mastery"]');
            var masteryValue = masteryCol.val();

            var conditionCol = $(columns).find('[name="condition"]');
            var conditionValue = conditionCol.val();

            var criteriaCol = $(columns).find('[name="criteria"]');
            var criteriaValue = criteriaCol.val();

            $.ajax({
                url: theAction,
                type: 'POST',
                headers: {
                    '_csrf':theCSRF
                },
                data: {
                    planObjectiveId:planObjectiveId, conditionId:conditionValue, criteriaId:criteriaValue, masteryValue:masteryValue,
                    _csrf:theCSRF
                },
                success: function (data) {
                },
                error: function() {
                }
            });
        });

    }
</script>

</body>
</html>